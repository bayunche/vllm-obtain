# VLLM 跨平台推理服务 - macOS 专用配置
# 优化 Apple Silicon (M1/M2/M3/M4) 性能

# =============================================================================
# 服务基础配置
# =============================================================================
HOST=0.0.0.0
PORT=8001
DEBUG=false
WORKERS=1  # MLX引擎只支持单worker

# =============================================================================
# 推理引擎配置 - Mac专用
# =============================================================================
INFERENCE_ENGINE=mlx  # Apple Silicon首选MLX
DEVICE_TYPE=mps       # Metal Performance Shaders
DEFAULT_MODEL=qwen-0.5b
MAX_CONCURRENT_MODELS=3  # 支持同时加载3个模型
MAX_SEQUENCE_LENGTH=128000  # 128k上下文长度，适配glm-4.5v

# MLX 特定配置
MLX_MEMORY_FRACTION=0.8  # 使用80%统一内存
MLX_PRECISION=float16    # 优化精度和速度平衡

# =============================================================================
# 模型和缓存配置
# =============================================================================
MODEL_DIR=./models/qwen-0.5b
MODEL_BASE_PATH=./models  # 多模型基础路径
CACHE_DIR=./cache
ENABLE_CACHING=true
CACHE_SIZE=1000
CACHE_TTL=3600

# =============================================================================
# 并发和性能配置
# =============================================================================
MAX_CONCURRENT_REQUESTS=10   # Mac Studio建议值
REQUEST_TIMEOUT=600  # 增加到10分钟
WORKER_CLASS=gevent
WORKER_CONNECTIONS=500
KEEP_ALIVE=2

# =============================================================================
# 内存管理
# =============================================================================
MEMORY_LIMIT=80  # 内存使用上限(%)
ENABLE_SWAP_PROTECTION=true
AUTO_CLEANUP_INTERVAL=3600

# =============================================================================
# 日志配置
# =============================================================================
LOG_LEVEL=INFO
LOG_DIR=./logs
ENABLE_LOG_FILE=true
LOG_RETENTION_DAYS=30
LOG_ROTATE_SIZE=100MB

# =============================================================================
# 安全配置
# =============================================================================
ALLOWED_HOSTS=127.0.0.1,localhost,0.0.0.0,host.docker.internal
CORS_ORIGINS=*
API_KEY_REQUIRED=false

# =============================================================================
# 监控配置
# =============================================================================
ENABLE_METRICS=true
METRICS_INTERVAL=60
HEALTH_CHECK_TIMEOUT=10

# =============================================================================
# Mac 特定优化
# =============================================================================
# 利用macOS系统特性
USE_SYSTEM_MALLOC=true
ENABLE_MEMORY_MAPPING=true
USE_ACCELERATE_FRAMEWORK=true

# 文件系统优化
USE_APFS_SNAPSHOTS=false
DISABLE_SPOTLIGHT_INDEXING=true

# =============================================================================
# 开发者配置
# =============================================================================
FLASK_ENV=production
PYTHONPATH=.
TZ=Asia/Shanghai

# =============================================================================
# 生产环境建议
# =============================================================================
# 对于生产环境，建议调整以下参数:
# MAX_CONCURRENT_REQUESTS=20  # Mac Studio M3 Ultra
# WORKERS=1                   # 保持单worker
# MEMORY_LIMIT=70             # 为系统预留更多内存
# LOG_LEVEL=WARNING           # 减少日志量

# =============================================================================
# 硬件配置建议
# =============================================================================
# Mac Studio M1 Max:    MAX_CONCURRENT_REQUESTS=8,  MEMORY_LIMIT=85
# Mac Studio M1 Ultra:  MAX_CONCURRENT_REQUESTS=15, MEMORY_LIMIT=80
# Mac Studio M2 Max:    MAX_CONCURRENT_REQUESTS=10, MEMORY_LIMIT=82
# Mac Studio M2 Ultra:  MAX_CONCURRENT_REQUESTS=18, MEMORY_LIMIT=78
# Mac Studio M3 Max:    MAX_CONCURRENT_REQUESTS=12, MEMORY_LIMIT=80
# Mac Studio M3 Ultra:  MAX_CONCURRENT_REQUESTS=20, MEMORY_LIMIT=75
# MacBook Pro M1/M2/M3: MAX_CONCURRENT_REQUESTS=5,  MEMORY_LIMIT=90